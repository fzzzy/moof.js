<!DOCTYPE html>
<html>
  <head>
    <title>Hello</title>
    <script src="engine.io.js"></script>
    <link rel="stylesheet" type="text/css" href="styles.css" />
  </head>
  <body>
  <form id="login-box">
    <h1>Welcome to moof</h1>
    <label for="name">Name</label>
    <input name="name" />
    <button>Log in</button>
  </form>
  <div id="tileset"></div>
  <select id="dig">
    <option value="move">Move</option>
    <option value="1">1 Sand</option>
    <option value="2">2 Grass</option>
    <option value="3">3 Rock</option>
    <option value="4">4 Water</option>
    <option value="5">5 Water, Grass Facing NW</option>
    <option value="6">6 Water, Grass Facing N</option>
    <option value="7">7 Water, Grass Facing NE</option>
    <option value="8">8 Water, Grass Facing W</option>
    <option value="9">9 Water, Grass Facing E</option>
    <option value="10">10 Water, Grass Facing SW</option>
    <option value="11">11 Water, Grass Facing S</option>
    <option value="12">12 Water, Grass Facing SE</option>
    <option value="13">13 Grass, Water Facing SE</option>
    <option value="14">14 Grass, Water Facing SW</option>
    <option value="15">15 Grass, Water Facing NE</option>
    <option value="16">16 Grass, Water Facing NW</option>
    <option value="17">17 Sand, Grass Facing NW</option>
    <option value="18">18 Sand, Grass Facing N</option>
    <option value="19">19 Sand, Grass Facing NE</option>
    <option value="20">20 Sand, Grass Facing W</option>
    <option value="21">21 Sand, Grass Facing E</option>
    <option value="22">22 Sand, Grass Facing SW</option>
    <option value="23">23 Sand, Grass Facing S</option>
    <option value="24">24 Sand, Grass Facing SE</option>
    <option value="25">25 Grass, Sand Facing SE</option>
    <option value="26">26 Grass, Sand Facing SW</option>
    <option value="27">27 Grass, Sand Facing NE</option>
    <option value="28">28 Grass, Sand Facing NW</option>
  </select>
  <form id="submit-input">
    <input name="msg" />
    <button>Send</button>
  </form>
  <script>

var login_box = document.getElementById("login-box");
var dig = document.getElementById("dig");

window.onload = function() {
  login_box.name.focus();
}

login_box.onsubmit = function(e) {
  e.preventDefault();
  login(login_box.name.value);
}

function login(player_name) {
  var pos = "";
  function add_player(pl) {
    var node = document.createElement("span");
    node.id = pl.address;
    node.textContent = pl.name;
    node.className = "player";
    var split = pl.pos.split(',');
    tile = tileimages[parseInt(split[1])][parseInt(split[0])];
    console.log(tile.offsetTop, tile.offsetLeft);
    node.style.top = (tile.offsetTop + 4) + "px";
    node.style.left = (tile.offsetLeft + 4) + "px";
    tileset.appendChild(node);
  }

  var socket = new eio.Socket('ws://localhost:8080/');
  socket.on('open', function () {
    socket.send(
      JSON.stringify(
        {pattern: "login", data: {name: player_name}}));

    socket.on('message', function (data) {
      var msg = JSON.parse(data);
      if (msg.pattern === "msg") {
        var node = document.createElement("div");
        node.textContent = msg.data;
        document.body.appendChild(node);   
      } else if (msg.pattern === "login") {
        pos = msg.data.pos;
        console.log("POS", pos);
      } else if (msg.pattern === "room") {
        console.log(data);
        for (var y = 0; y < 16; y++) {
          for (var x = 0; x < 16; x++) {
            tileimages[y][x].src = "tiles/" + msg.data.tiles[y][x] + ".png";
          }
        }
        for (var i = 0; i < msg.data.players.length; i++) {
          add_player(msg.data.players[i]);
        }
      } else if (msg.pattern === "join") {
        add_player(msg.data);
      } else if (msg.pattern === "part") {
        var player_node = document.getElementById(msg.data.address);
        player_node.parentNode.removeChild(player_node);
      } else if (msg.pattern === "go") {
        var node = document.getElementById(msg.data.address);
        var split = msg.data.pos.split(',');
        tile = tileimages[parseInt(split[1])][parseInt(split[0])];
        console.log(tile.offsetTop, tile.offsetLeft);
        node.style.top = (tile.offsetTop + 4) + "px";
        node.style.left = (tile.offsetLeft + 4) + "px";
      } else if (msg.pattern === "dig") {
        var split = msg.data.pos.split(",");
        tileimages[parseInt(split[1])][parseInt(split[0])].src = (
          "tiles/" + msg.data.tile + ".png");
      } else {
        console.log(data);
      }
    });
    socket.on('close', function () { console.log("close"); });
  });

  function create_onclick(x, y) {
    return function(e) {
      console.log("dig.value", dig.value, x, y);
      if (dig.value === "move") {
        socket.send(JSON.stringify({pattern: 'go', data: "" + x + "," + y}));
      } else {
        socket.send(
          JSON.stringify(
            {pattern: 'dig', data: {'pos': "" + x + "," + y, 'tile': dig.value}}));
      }
    }
  }
  
  var tileset = document.getElementById("tileset");
  var tileimages = [];
  
  for (var y = 0; y < 16; y++) {
    var row = document.createElement("div");
    var rowarray = [];
    for (var x = 0; x < 16; x++) {
      var img = document.createElement("img");
      img.onclick = create_onclick(x, y);
      rowarray.push(img);
      row.appendChild(img);
    }
    tileimages.push(rowarray);
    tileset.appendChild(row);
  }

  document.getElementById("submit-input").onsubmit = function(e) {
    e.preventDefault();
    socket.send(JSON.stringify({'pattern': 'msg', 'data': this.msg.value}));
    this.msg.value = "";
  };

  document.getElementById("login-box").style.display = "none";
}

  </script>
  </body>
</html>
